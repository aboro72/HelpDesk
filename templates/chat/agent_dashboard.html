{% extends 'base.html' %}

{% block title %}Live Chat Dashboard - {{ app_title }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 style="font-size: 28px; font-weight: 600; margin: 0;">Live Chat Dashboard</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
        <span id="status-indicator" style="display: inline-block; width: 10px; height: 10px; background: #51cf66; border-radius: 50%; margin-right: 5px;"></span>
        <span style="font-size: 14px; color: #495057;">Online</span>
        
        <!-- Notification Controls -->
        <button id="notification-btn" onclick="toggleNotifications()" class="btn btn-info btn-sm" style="margin-left: 15px;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            Benachrichtigungen
        </button>
        
        <button onclick="refreshDashboard()" class="btn btn-secondary btn-sm">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Aktualisieren
        </button>
    </div>
</div>

<!-- Chat Tabs Container -->
<div id="chat-tabs-container" style="margin-bottom: 20px;">
    <div id="chat-tabs" class="card" style="display: none; margin-bottom: 20px; padding: 0; overflow: hidden;">
        <div style="background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 10px 20px;">
            <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Aktive Chat-Tabs</h4>
        </div>
        <div id="chat-tabs-nav" style="display: flex; border-bottom: 1px solid #dee2e6; background: #fff; overflow-x: auto;">
            <!-- Tabs werden hier dynamisch hinzugef√ºgt -->
        </div>
        <div id="chat-tabs-content" style="height: 500px; overflow: hidden;">
            <!-- Chat-Inhalte werden hier angezeigt -->
        </div>
    </div>
</div>

<!-- Statistics -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Wartende Chats</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #ff6b6b;" id="waiting-count">{{ waiting_chats.count }}</p>
    </div>
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Eskalierte Chats</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #ffa94d;" id="escalated-count">{{ escalated_chats.count }}</p>
    </div>
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Meine aktiven Chats</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #51cf66;" id="active-count">{{ active_chats.count }}</p>
    </div>
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">KI-Chats verf√ºgbar</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #4ecdc4;" id="ai-count">{{ ai_handled_chats.count }}</p>
    </div>
</div>

<!-- Waiting Chats -->
{% if waiting_chats %}
<div class="card" style="margin-bottom: 30px;">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #ff6b6b;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Wartende Chats ({{ waiting_chats.count }})
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Erste Nachricht</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Wartezeit</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in waiting_chats %}
                <tr style="border-bottom: 1px solid #dee2e6;" id="waiting-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #868e96;">{{ chat.visitor_ip }}</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #667eea; text-decoration: none;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ chat.initial_message }}
                        </div>
                    </td>
                    <td style="padding: 15px;">
                        <span class="waiting-time" data-created="{{ chat.created_at.isoformat }}">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="takeChat('{{ chat.session_id }}')" class="btn btn-success btn-sm">
                                Chat √ºbernehmen
                            </button>
                            <button onclick="openChatTab('{{ chat.session_id }}', '{{ chat.visitor_name }}')" class="btn btn-primary btn-sm">
                                In Tab √∂ffnen
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="margin-bottom: 30px; text-align: center; padding: 40px;">
    <svg width="48" height="48" fill="#868e96" viewBox="0 0 24 24" style="margin-bottom: 16px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
    <h3 style="color: #868e96; margin: 0 0 8px 0;">Keine wartenden Chats</h3>
    <p style="color: #adb5bd; margin: 0;">Alle Besucher sind momentan versorgt.</p>
</div>
{% endif %}

<!-- Escalated Chats -->
{% if escalated_chats %}
<div class="card" style="margin-bottom: 30px;">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #ffa94d;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Eskalierte Chats ({{ escalated_chats.count }}) - Ben√∂tigen Aufmerksamkeit!
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #fff3cd; border-bottom: 2px solid #ffeaa7;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #856404;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #856404;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #856404;">Erste Nachricht</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #856404;">Eskaliert seit</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #856404;">Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in escalated_chats %}
                <tr style="border-bottom: 1px solid #ffeaa7; background: #fffbf0;" id="escalated-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: #856404;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #856404; opacity: 0.8;">{{ chat.visitor_ip }}</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #d9534f; text-decoration: none; font-weight: 600;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #856404;">
                            {{ chat.initial_message }}
                        </div>
                    </td>
                    <td style="padding: 15px;">
                        <span class="waiting-time" data-created="{{ chat.created_at.isoformat }}" style="color: #d9534f; font-weight: 600;">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="takeChat('{{ chat.session_id }}')" class="btn btn-warning" style="background: #ffa94d; border-color: #ffa94d;">
                                Sofort √ºbernehmen
                            </button>
                            <button onclick="openChatTab('{{ chat.session_id }}', '{{ chat.visitor_name }}')" class="btn btn-primary btn-sm">
                                In Tab √∂ffnen
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- AI-Handled Chats -->
{% if ai_handled_chats %}
<div class="card" style="margin-bottom: 30px;">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #4ecdc4;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/>
        </svg>
        KI-assistierte Chats ({{ ai_handled_chats.count }}) - Verf√ºgbar zur √úbernahme
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #e0f7fa; border-bottom: 2px solid #4ecdc4;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #00695c;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #00695c;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #00695c;">Erste Nachricht</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #00695c;">KI-Chat seit</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #00695c;">Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in ai_handled_chats %}
                <tr style="border-bottom: 1px solid #b2ebf2;" id="ai-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: #00695c;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #00695c; opacity: 0.7;">{{ chat.visitor_ip }}</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #4ecdc4; text-decoration: none;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #00695c;">
                            {{ chat.initial_message }}
                        </div>
                    </td>
                    <td style="padding: 15px;">
                        <span class="chat-duration" data-created="{{ chat.created_at.isoformat }}" style="color: #4ecdc4; font-weight: 500;">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="takeChat('{{ chat.session_id }}')" class="btn" style="background: #4ecdc4; color: white; border-color: #4ecdc4;">
                                Von KI √ºbernehmen
                            </button>
                            <button onclick="openChatTab('{{ chat.session_id }}', '{{ chat.visitor_name }}')" class="btn btn-secondary btn-sm">
                                Ansehen
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Active Chats -->
{% if active_chats %}
<div class="card">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #51cf66;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3.04 1.05 4.35L2 22l5.65-1.05C9.96 21.64 11.46 22 13 22h-1c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
        </svg>
        Meine aktiven Chats ({{ active_chats.count }})
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Chat-Dauer</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Letzte Aktivit√§t</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in active_chats %}
                <tr style="border-bottom: 1px solid #dee2e6;" id="active-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #868e96;">Session: {{ chat.session_id|slice:":8" }}...</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #667eea; text-decoration: none;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <span class="chat-duration" data-created="{{ chat.created_at.isoformat }}">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <span style="font-size: 12px; color: #868e96;">
                            {% if chat.messages.last %}
                                {{ chat.messages.last.timestamp|timesince }} ago
                            {% else %}
                                Gerade gestartet
                            {% endif %}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="openChatTab('{{ chat.session_id }}', '{{ chat.visitor_name }}')" class="btn btn-primary btn-sm">
                                In Tab √∂ffnen
                            </button>
                            <a href="{% url 'chat:chat_detail' chat.session_id %}" class="btn btn-secondary btn-sm">
                                Vollansicht
                            </a>
                            <button onclick="endChat('{{ chat.session_id }}')" class="btn btn-danger btn-sm">
                                Beenden
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <svg width="48" height="48" fill="#868e96" viewBox="0 0 24 24" style="margin-bottom: 16px;">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3.04 1.05 4.35L2 22l5.65-1.05C9.96 21.64 11.46 22 13 22h-1c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
    </svg>
    <h3 style="color: #868e96; margin: 0 0 8px 0;">Keine aktiven Chats</h3>
    <p style="color: #adb5bd; margin: 0;">Sie haben momentan keine laufenden Chats.</p>
</div>
{% endif %}

<script>
// Global variables for chat management
let openChatTabs = new Map(); // sessionId -> chat data
let activeTabId = null;
let notificationsEnabled = false;
let unreadMessages = new Map(); // sessionId -> count
let pollInterval;

// Audio notification
const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgdBjiS3+/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgdBjiS3+/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgdBjiS3+/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgdBjiS3+/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgdBg==');

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    setupNotificationPermissions();
    startPolling();
    loadSavedTabs();
});

function takeChat(sessionId) {
    if (confirm('M√∂chten Sie diesen Chat √ºbernehmen?')) {
        fetch(`/chat/api/take/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open in tab instead of redirect
                openChatTab(sessionId, 'Chat √ºbernommen');
                refreshDashboard();
            } else {
                alert('Fehler beim √úbernehmen des Chats: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim √úbernehmen des Chats.');
        });
    }
}

function endChat(sessionId) {
    if (confirm('M√∂chten Sie diesen Chat beenden?')) {
        fetch(`/chat/api/end/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove from active chats
                const row = document.getElementById(`active-chat-${sessionId}`);
                if (row) {
                    row.remove();
                }
                updateCounts();
                alert('Chat wurde beendet.');
            } else {
                alert('Fehler beim Beenden des Chats: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Beenden des Chats.');
        });
    }
}

function refreshDashboard() {
    window.location.reload();
}

function updateCounts() {
    const waitingCount = document.querySelectorAll('[id^="waiting-chat-"]').length;
    const activeCount = document.querySelectorAll('[id^="active-chat-"]').length;
    
    document.getElementById('waiting-count').textContent = waitingCount;
    document.getElementById('active-count').textContent = activeCount;
}

function updateWaitingTimes() {
    document.querySelectorAll('.waiting-time').forEach(element => {
        const createdAt = new Date(element.dataset.created);
        const now = new Date();
        const diffMs = now - createdAt;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) {
            element.textContent = 'Gerade eben';
        } else if (diffMins < 60) {
            element.textContent = `${diffMins} Min`;
        } else {
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            element.textContent = `${hours}h ${mins}m`;
        }
        
        // Highlight long waiting times
        if (diffMins > 5) {
            element.style.color = '#ff6b6b';
            element.style.fontWeight = '600';
        }
    });
}

function updateChatDurations() {
    document.querySelectorAll('.chat-duration').forEach(element => {
        const createdAt = new Date(element.dataset.created);
        const now = new Date();
        const diffMs = now - createdAt;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) {
            element.textContent = '< 1 Min';
        } else if (diffMins < 60) {
            element.textContent = `${diffMins} Min`;
        } else {
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            element.textContent = `${hours}h ${mins}m`;
        }
    });
}

// Update times every 30 seconds
setInterval(() => {
    updateWaitingTimes();
    updateChatDurations();
}, 30000);

// Initial update
updateWaitingTimes();
updateChatDurations();

// Chat Tab Management Functions
function openChatTab(sessionId, visitorName) {
    // Check if tab is already open
    if (openChatTabs.has(sessionId)) {
        switchToTab(sessionId);
        return;
    }
    
    // Add to open tabs
    openChatTabs.set(sessionId, {
        sessionId: sessionId,
        visitorName: visitorName,
        unreadCount: 0,
        lastMessageId: 0
    });
    
    // Take the chat first
    fetch(`/chat/api/take/${sessionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            createTabUI(sessionId, visitorName);
            loadChatMessages(sessionId);
            switchToTab(sessionId);
            showChatTabs();
            saveTabs();
        } else {
            openChatTabs.delete(sessionId);
            alert('Fehler beim √ñffnen des Chats: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        openChatTabs.delete(sessionId);
        alert('Fehler beim √ñffnen des Chats.');
    });
}

function createTabUI(sessionId, visitorName) {
    const tabsNav = document.getElementById('chat-tabs-nav');
    const tabsContent = document.getElementById('chat-tabs-content');
    
    // Create tab button
    const tabButton = document.createElement('div');
    tabButton.className = 'chat-tab';
    tabButton.id = `tab-${sessionId}`;
    tabButton.innerHTML = `
        <button onclick="switchToTab('${sessionId}')" style="
            background: none; border: none; padding: 12px 16px; cursor: pointer;
            border-right: 1px solid #dee2e6; display: flex; align-items: center; gap: 8px;
            font-size: 14px; white-space: nowrap;
        ">
            <span class="tab-name">${visitorName}</span>
            <span class="unread-badge" style="
                background: #ff6b6b; color: white; border-radius: 10px; 
                padding: 2px 6px; font-size: 11px; font-weight: 600; display: none;
            ">0</span>
            <span onclick="closeChatTab('${sessionId}'); event.stopPropagation();" style="
                color: #868e96; hover: #495057; padding: 2px; cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                width: 16px; height: 16px; border-radius: 3px;
            ">&times;</span>
        </button>
    `;
    tabsNav.appendChild(tabButton);
    
    // Create tab content
    const tabContent = document.createElement('div');
    tabContent.className = 'chat-tab-content';
    tabContent.id = `content-${sessionId}`;
    tabContent.style.display = 'none';
    tabContent.style.height = '100%';
    tabContent.innerHTML = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div style="background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 15px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h5 style="margin: 0; font-weight: 600;">${visitorName}</h5>
                        <small style="color: #868e96;" id="chat-status-${sessionId}">Aktiver Chat</small>
                    </div>
                    <button onclick="endChat('${sessionId}')" class="btn btn-danger btn-sm">
                        Chat beenden
                    </button>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div id="messages-${sessionId}" style="flex: 1; overflow-y: auto; padding: 20px; background: #fff;">
                <div style="text-align: center; color: #868e96; padding: 20px;">
                    Lade Chat-Nachrichten...
                </div>
            </div>
            
            <!-- Message Input -->
            <div style="border-top: 1px solid #dee2e6; padding: 15px 20px; background: #fff;">
                <form onsubmit="sendMessage('${sessionId}'); return false;" style="display: flex; gap: 10px;">
                    <input type="text" id="message-input-${sessionId}" placeholder="Nachricht eingeben..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    <button type="submit" class="btn btn-primary">Senden</button>
                </form>
            </div>
        </div>
    `;
    tabsContent.appendChild(tabContent);
}

function switchToTab(sessionId) {
    // Hide all tab contents
    document.querySelectorAll('.chat-tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.chat-tab button').forEach(button => {
        button.style.background = 'none';
        button.style.color = '#495057';
    });
    
    // Show selected tab content
    const targetContent = document.getElementById(`content-${sessionId}`);
    if (targetContent) {
        targetContent.style.display = 'block';
        activeTabId = sessionId;
        
        // Mark tab as active
        const targetTab = document.querySelector(`#tab-${sessionId} button`);
        if (targetTab) {
            targetTab.style.background = '#667eea';
            targetTab.style.color = 'white';
        }
        
        // Clear unread count for this tab
        if (openChatTabs.has(sessionId)) {
            const chatData = openChatTabs.get(sessionId);
            chatData.unreadCount = 0;
            updateUnreadBadge(sessionId, 0);
        }
        
        // Focus message input
        const messageInput = document.getElementById(`message-input-${sessionId}`);
        if (messageInput) {
            messageInput.focus();
        }
        
        // Scroll to bottom of messages
        const messagesContainer = document.getElementById(`messages-${sessionId}`);
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
}

function closeChatTab(sessionId) {
    if (confirm('Chat-Tab schlie√üen? Der Chat bleibt aktiv.')) {
        // Remove from open tabs
        openChatTabs.delete(sessionId);
        
        // Remove UI elements
        const tabElement = document.getElementById(`tab-${sessionId}`);
        const contentElement = document.getElementById(`content-${sessionId}`);
        
        if (tabElement) tabElement.remove();
        if (contentElement) contentElement.remove();
        
        // If this was the active tab, switch to another tab or hide tabs
        if (activeTabId === sessionId) {
            const remainingTabs = Array.from(openChatTabs.keys());
            if (remainingTabs.length > 0) {
                switchToTab(remainingTabs[0]);
            } else {
                hideChatTabs();
            }
        }
        
        saveTabs();
    }
}

function showChatTabs() {
    document.getElementById('chat-tabs').style.display = 'block';
}

function hideChatTabs() {
    document.getElementById('chat-tabs').style.display = 'none';
    activeTabId = null;
}

function loadChatMessages(sessionId) {
    fetch(`/chat/api/messages/${sessionId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const messagesContainer = document.getElementById(`messages-${sessionId}`);
                if (messagesContainer) {
                    displayMessages(sessionId, data.messages);
                    
                    // Update last message ID
                    if (openChatTabs.has(sessionId) && data.messages.length > 0) {
                        const chatData = openChatTabs.get(sessionId);
                        chatData.lastMessageId = Math.max(...data.messages.map(m => m.id));
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        });
}

function displayMessages(sessionId, messages) {
    const messagesContainer = document.getElementById(`messages-${sessionId}`);
    if (!messagesContainer) return;
    
    messagesContainer.innerHTML = '';
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.style.marginBottom = '15px';
        
        const isFromVisitor = message.is_from_visitor;
        const isSystem = message.message_type === 'system';
        
        let messageClass = 'chat-message';
        let messageStyle = `
            max-width: 70%; padding: 12px 16px; border-radius: 12px; 
            word-wrap: break-word; font-size: 14px; line-height: 1.4;
        `;
        
        if (isSystem) {
            messageStyle += `
                background: #f8f9fa; color: #495057; border: 1px solid #dee2e6;
                margin: 10px auto; text-align: center; max-width: 90%;
                font-style: italic;
            `;
        } else if (isFromVisitor) {
            messageStyle += `
                background: #e3f2fd; color: #1976d2; margin-left: 0; margin-right: auto;
            `;
        } else {
            messageStyle += `
                background: #667eea; color: white; margin-left: auto; margin-right: 0;
            `;
        }
        
        const timestamp = new Date(message.timestamp).toLocaleTimeString('de-DE', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageDiv.innerHTML = `
            <div style="${messageStyle}">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px; opacity: 0.8;">
                    ${message.sender_name}
                </div>
                <div>${message.message}</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 6px; text-align: right;">
                    ${timestamp}
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendMessage(sessionId) {
    const messageInput = document.getElementById(`message-input-${sessionId}`);
    if (!messageInput) return;
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Clear input
    messageInput.value = '';
    
    // Send message
    fetch(`/chat/api/send/${sessionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload messages for this tab
            loadChatMessages(sessionId);
        } else {
            alert('Fehler beim Senden der Nachricht: ' + data.error);
            messageInput.value = message; // Restore message
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Fehler beim Senden der Nachricht.');
        messageInput.value = message; // Restore message
    });
}

function updateUnreadBadge(sessionId, count) {
    const badge = document.querySelector(`#tab-${sessionId} .unread-badge`);
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Notification Management
function setupNotificationPermissions() {
    if ("Notification" in window) {
        if (Notification.permission === "default") {
            Notification.requestPermission().then(permission => {
                updateNotificationButton(permission === "granted");
            });
        } else {
            updateNotificationButton(Notification.permission === "granted");
        }
    }
}

function toggleNotifications() {
    if ("Notification" in window) {
        if (Notification.permission === "granted") {
            notificationsEnabled = !notificationsEnabled;
            updateNotificationButton(notificationsEnabled);
            localStorage.setItem('chatNotificationsEnabled', notificationsEnabled);
            
            if (notificationsEnabled) {
                showNotification('Benachrichtigungen aktiviert', 'Sie erhalten jetzt Chat-Benachrichtigungen.');
            }
        } else if (Notification.permission === "default") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationsEnabled = true;
                    updateNotificationButton(true);
                    localStorage.setItem('chatNotificationsEnabled', true);
                }
            });
        } else {
            alert('Benachrichtigungen sind in Ihrem Browser blockiert. Bitte aktivieren Sie sie in den Browser-Einstellungen.');
        }
    }
}

function updateNotificationButton(enabled) {
    const button = document.getElementById('notification-btn');
    if (button) {
        if (enabled) {
            button.style.background = '#51cf66';
            button.style.color = 'white';
            button.textContent = 'üîî An';
        } else {
            button.style.background = '#868e96';
            button.style.color = 'white';
            button.textContent = 'üîï Aus';
        }
    }
}

function showNotification(title, message) {
    if (notificationsEnabled && "Notification" in window && Notification.permission === "granted") {
        try {
            notificationSound.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio not supported:', e);
        }
        
        new Notification(title, {
            body: message,
            icon: '/static/logo.jpg',
            tag: 'chat-notification',
            requireInteraction: false
        });
    }
}

// Polling for new messages
function startPolling() {
    // Check for new messages in open chat tabs
    pollInterval = setInterval(() => {
        checkForNewMessages();
        checkForNewChats();
    }, 3000); // Check every 3 seconds
}

function checkForNewMessages() {
    openChatTabs.forEach((chatData, sessionId) => {
        fetch(`/chat/api/messages/${sessionId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    const latestMessageId = Math.max(...data.messages.map(m => m.id));
                    
                    if (latestMessageId > chatData.lastMessageId) {
                        // New messages detected
                        const newMessages = data.messages.filter(m => m.id > chatData.lastMessageId);
                        
                        // Update last message ID
                        chatData.lastMessageId = latestMessageId;
                        
                        // If this tab is not active, increment unread count
                        if (activeTabId !== sessionId) {
                            chatData.unreadCount += newMessages.filter(m => m.is_from_visitor).length;
                            updateUnreadBadge(sessionId, chatData.unreadCount);
                            
                            // Show notification for new visitor messages
                            const visitorMessages = newMessages.filter(m => m.is_from_visitor);
                            if (visitorMessages.length > 0) {
                                showNotification(
                                    `Neue Nachricht von ${chatData.visitorName}`,
                                    visitorMessages[0].message
                                );
                            }
                        }
                        
                        // Update messages display
                        displayMessages(sessionId, data.messages);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking messages:', error);
            });
    });
}

function checkForNewChats() {
    // Check for new waiting chats
    fetch('/chat/api/dashboard/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const currentWaitingCount = parseInt(document.getElementById('waiting-count').textContent);
                const newWaitingCount = data.waiting_chats || 0;
                
                // If there are new waiting chats, show notification and refresh dashboard
                if (newWaitingCount > currentWaitingCount) {
                    const newChatsCount = newWaitingCount - currentWaitingCount;
                    showNotification(
                        `${newChatsCount} neue${newChatsCount > 1 ? ' Chats' : 'r Chat'} wartet${newChatsCount === 1 ? '' : 'n'}`,
                        'Neue Besucher ben√∂tigen Unterst√ºtzung.'
                    );
                    
                    // Update counts immediately
                    document.getElementById('waiting-count').textContent = newWaitingCount;
                    document.getElementById('active-count').textContent = data.active_chats || 0;
                    document.getElementById('escalated-count').textContent = data.escalated_chats || 0;
                    document.getElementById('ai-count').textContent = data.ai_handled_chats || 0;
                    
                    // Flash the waiting count to draw attention
                    const waitingElement = document.getElementById('waiting-count');
                    waitingElement.style.background = '#ff6b6b';
                    waitingElement.style.color = 'white';
                    waitingElement.style.padding = '5px 10px';
                    waitingElement.style.borderRadius = '15px';
                    waitingElement.style.transition = 'all 0.3s';
                    
                    setTimeout(() => {
                        waitingElement.style.background = 'none';
                        waitingElement.style.color = '#ff6b6b';
                        waitingElement.style.padding = '0';
                    }, 3000);
                    
                    // Refresh the dashboard after a short delay to show new chats
                    setTimeout(() => {
                        if (openChatTabs.size === 0) {
                            refreshDashboard();
                        }
                    }, 2000);
                }
                
                // Update escalated chats count if we have that info
                if (data.escalated_chats !== undefined) {
                    // Add escalated chat notifications if needed
                    // This could be expanded later
                }
            }
        })
        .catch(error => {
            console.error('Error checking for new chats:', error);
        });
}

// Save and restore tab state
function saveTabs() {
    const tabData = Array.from(openChatTabs.values());
    localStorage.setItem('openChatTabs', JSON.stringify(tabData));
}

function loadSavedTabs() {
    try {
        const savedTabs = localStorage.getItem('openChatTabs');
        const savedNotificationSetting = localStorage.getItem('chatNotificationsEnabled');
        
        if (savedNotificationSetting) {
            notificationsEnabled = savedNotificationSetting === 'true';
            updateNotificationButton(notificationsEnabled);
        }
        
        if (savedTabs) {
            const tabsData = JSON.parse(savedTabs);
            tabsData.forEach(tabData => {
                // Re-open saved tabs
                openChatTab(tabData.sessionId, tabData.visitorName);
            });
        }
    } catch (error) {
        console.error('Error loading saved tabs:', error);
        localStorage.removeItem('openChatTabs');
    }
}

// Auto-refresh dashboard every 60 seconds (but not if user is in a chat tab)
setInterval(() => {
    if (openChatTabs.size === 0) {
        refreshDashboard();
    } else {
        // Just update counts without full refresh
        updateCounts();
        updateWaitingTimes();
        updateChatDurations();
    }
}, 60000);
</script>
{% endblock %}