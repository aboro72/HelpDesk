{% extends 'base.html' %}

{% block title %}Live Chat Dashboard - {{ app_title }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1 style="font-size: 28px; font-weight: 600; margin: 0;">Live Chat Dashboard</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
        <span id="status-indicator" style="display: inline-block; width: 10px; height: 10px; background: #51cf66; border-radius: 50%; margin-right: 5px;"></span>
        <span style="font-size: 14px; color: #495057;">Online</span>
        <button onclick="refreshDashboard()" class="btn btn-secondary btn-sm" style="margin-left: 15px;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Aktualisieren
        </button>
    </div>
</div>

<!-- Statistics -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Wartende Chats</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #ff6b6b;" id="waiting-count">{{ waiting_chats.count }}</p>
    </div>
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Meine aktiven Chats</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #51cf66;" id="active-count">{{ active_chats.count }}</p>
    </div>
    <div class="card">
        <h3 style="font-size: 14px; font-weight: 600; color: #868e96; margin: 0 0 8px 0;">Heute bearbeitet</h3>
        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #667eea;" id="today-count">0</p>
    </div>
</div>

<!-- Waiting Chats -->
{% if waiting_chats %}
<div class="card" style="margin-bottom: 30px;">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #ff6b6b;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Wartende Chats ({{ waiting_chats.count }})
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Erste Nachricht</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Wartezeit</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in waiting_chats %}
                <tr style="border-bottom: 1px solid #dee2e6;" id="waiting-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #868e96;">{{ chat.visitor_ip }}</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #667eea; text-decoration: none;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ chat.initial_message }}
                        </div>
                    </td>
                    <td style="padding: 15px;">
                        <span class="waiting-time" data-created="{{ chat.created_at.isoformat }}">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <button onclick="takeChat('{{ chat.session_id }}')" class="btn btn-success btn-sm">
                            Chat übernehmen
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="margin-bottom: 30px; text-align: center; padding: 40px;">
    <svg width="48" height="48" fill="#868e96" viewBox="0 0 24 24" style="margin-bottom: 16px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
    <h3 style="color: #868e96; margin: 0 0 8px 0;">Keine wartenden Chats</h3>
    <p style="color: #adb5bd; margin: 0;">Alle Besucher sind momentan versorgt.</p>
</div>
{% endif %}

<!-- Active Chats -->
{% if active_chats %}
<div class="card">
    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #51cf66;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3.04 1.05 4.35L2 22l5.65-1.05C9.96 21.64 11.46 22 13 22h-1c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
        </svg>
        Meine aktiven Chats ({{ active_chats.count }})
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Besucher</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">E-Mail</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Chat-Dauer</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Letzte Aktivität</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; color: #495057;">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in active_chats %}
                <tr style="border-bottom: 1px solid #dee2e6;" id="active-chat-{{ chat.session_id }}">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600;">{{ chat.visitor_name }}</div>
                        <div style="font-size: 12px; color: #868e96;">Session: {{ chat.session_id|slice:":8" }}...</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:{{ chat.visitor_email }}" style="color: #667eea; text-decoration: none;">{{ chat.visitor_email }}</a>
                    </td>
                    <td style="padding: 15px;">
                        <span class="chat-duration" data-created="{{ chat.created_at.isoformat }}">
                            {{ chat.duration }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <span style="font-size: 12px; color: #868e96;">
                            {% if chat.messages.last %}
                                {{ chat.messages.last.timestamp|timesince }} ago
                            {% else %}
                                Gerade gestartet
                            {% endif %}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <a href="{% url 'chat:chat_detail' chat.session_id %}" class="btn btn-primary btn-sm">
                                Chat öffnen
                            </a>
                            <button onclick="endChat('{{ chat.session_id }}')" class="btn btn-danger btn-sm">
                                Beenden
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <svg width="48" height="48" fill="#868e96" viewBox="0 0 24 24" style="margin-bottom: 16px;">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3.04 1.05 4.35L2 22l5.65-1.05C9.96 21.64 11.46 22 13 22h-1c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
    </svg>
    <h3 style="color: #868e96; margin: 0 0 8px 0;">Keine aktiven Chats</h3>
    <p style="color: #adb5bd; margin: 0;">Sie haben momentan keine laufenden Chats.</p>
</div>
{% endif %}

<script>
function takeChat(sessionId) {
    if (confirm('Möchten Sie diesen Chat übernehmen?')) {
        fetch(`/chat/api/take/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to chat detail
                window.location.href = `/chat/session/${sessionId}/`;
            } else {
                alert('Fehler beim Übernehmen des Chats: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Übernehmen des Chats.');
        });
    }
}

function endChat(sessionId) {
    if (confirm('Möchten Sie diesen Chat beenden?')) {
        fetch(`/chat/api/end/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove from active chats
                const row = document.getElementById(`active-chat-${sessionId}`);
                if (row) {
                    row.remove();
                }
                updateCounts();
                alert('Chat wurde beendet.');
            } else {
                alert('Fehler beim Beenden des Chats: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Beenden des Chats.');
        });
    }
}

function refreshDashboard() {
    window.location.reload();
}

function updateCounts() {
    const waitingCount = document.querySelectorAll('[id^="waiting-chat-"]').length;
    const activeCount = document.querySelectorAll('[id^="active-chat-"]').length;
    
    document.getElementById('waiting-count').textContent = waitingCount;
    document.getElementById('active-count').textContent = activeCount;
}

function updateWaitingTimes() {
    document.querySelectorAll('.waiting-time').forEach(element => {
        const createdAt = new Date(element.dataset.created);
        const now = new Date();
        const diffMs = now - createdAt;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) {
            element.textContent = 'Gerade eben';
        } else if (diffMins < 60) {
            element.textContent = `${diffMins} Min`;
        } else {
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            element.textContent = `${hours}h ${mins}m`;
        }
        
        // Highlight long waiting times
        if (diffMins > 5) {
            element.style.color = '#ff6b6b';
            element.style.fontWeight = '600';
        }
    });
}

function updateChatDurations() {
    document.querySelectorAll('.chat-duration').forEach(element => {
        const createdAt = new Date(element.dataset.created);
        const now = new Date();
        const diffMs = now - createdAt;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) {
            element.textContent = '< 1 Min';
        } else if (diffMins < 60) {
            element.textContent = `${diffMins} Min`;
        } else {
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            element.textContent = `${hours}h ${mins}m`;
        }
    });
}

// Update times every 30 seconds
setInterval(() => {
    updateWaitingTimes();
    updateChatDurations();
}, 30000);

// Initial update
updateWaitingTimes();
updateChatDurations();

// Auto-refresh dashboard every 60 seconds
setInterval(() => {
    refreshDashboard();
}, 60000);
</script>
{% endblock %}