{% extends 'base.html' %}

{% block title %}Chat mit {{ session.visitor_name }} - {{ app_title }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h1 style="font-size: 24px; font-weight: 600; margin: 0 0 5px 0;">
            Chat mit {{ session.visitor_name }}
        </h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span class="status-badge status-{{ session.status }}">
                {% if session.status == 'waiting' %}Wartend{% endif %}
                {% if session.status == 'active' %}Aktiv{% endif %}
                {% if session.status == 'ended' %}Beendet{% endif %}
            </span>
            <span style="color: #868e96; font-size: 14px;">
                Session: {{ session.session_id|slice:":8" }}...
            </span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px;">
        <a href="{% url 'chat:agent_dashboard' %}" class="btn btn-secondary">
            ← Zurück zum Dashboard
        </a>
        {% if can_respond and session.status == 'active' %}
        <button onclick="endChat()" class="btn btn-danger">
            Chat beenden
        </button>
        {% endif %}
    </div>
</div>

<!-- Chat Info -->
<div class="card" style="margin-bottom: 20px;">
    <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 15px 0;">Chat-Informationen</h3>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Besucher</p>
            <p style="font-weight: 500;">{{ session.visitor_name }}</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">E-Mail</p>
            <p style="font-weight: 500;">
                <a href="mailto:{{ session.visitor_email }}" style="color: #667eea; text-decoration: none;">{{ session.visitor_email }}</a>
            </p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Gestartet am</p>
            <p style="font-weight: 500;">{{ session.created_at|date:"d.m.Y H:i" }} Uhr</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Zugewiesen an</p>
            <p style="font-weight: 500;">
                {% if session.assigned_agent %}
                    {{ session.assigned_agent.full_name }}
                {% else %}
                    <span style="color: #868e96;">Nicht zugewiesen</span>
                {% endif %}
            </p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">IP-Adresse</p>
            <p style="font-weight: 500;">{{ session.visitor_ip }}</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Seite</p>
            <p style="font-weight: 500;">
                {% if session.visitor_page_url %}
                    <a href="{{ session.visitor_page_url }}" target="_blank" style="color: #667eea; text-decoration: none;">
                        {{ session.visitor_page_url|truncatechars:50 }}
                    </a>
                {% else %}
                    <span style="color: #868e96;">Nicht verfügbar</span>
                {% endif %}
            </p>
        </div>
        {% if session.ended_at %}
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Beendet am</p>
            <p style="font-weight: 500;">{{ session.ended_at|date:"d.m.Y H:i" }} Uhr</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Chat-Dauer</p>
            <p style="font-weight: 500;">{{ session.duration }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Chat Messages -->
<div class="card">
    <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 20px 0;">Chat-Verlauf</h3>
    
    <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; background: #f8f9fa; margin-bottom: 20px;">
        {% for message in messages %}
        <div style="margin-bottom: 15px;" class="chat-message" data-message-id="{{ message.id }}">
            {% if message.message_type == 'system' %}
                <!-- System Message -->
                <div style="text-align: center; color: #868e96; font-size: 12px; font-style: italic; padding: 8px;">
                    {{ message.message }}
                </div>
            {% else %}
                <!-- Regular Message -->
                {% if message.is_from_visitor %}
                    <!-- Visitor Message -->
                    <div style="margin-left: 60px; text-align: right;">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 14px; background: #667eea; color: white; border-radius: 18px 18px 4px 18px; word-wrap: break-word;">
                            {{ message.message|linebreaks }}
                        </div>
                        <div style="font-size: 11px; color: #868e96; margin-top: 4px;">
                            {{ message.sender_name }} • {{ message.timestamp|date:"H:i" }}
                        </div>
                    </div>
                {% else %}
                    <!-- Agent Message -->
                    <div style="margin-right: 60px;">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 14px; background: white; color: #333; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;">
                            {{ message.message|linebreaks }}
                        </div>
                        <div style="font-size: 11px; color: #868e96; margin-top: 4px;">
                            {{ message.sender_name }} • {{ message.timestamp|date:"H:i" }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        {% empty %}
        <div style="text-align: center; color: #868e96; padding: 40px;">
            Noch keine Nachrichten in diesem Chat.
        </div>
        {% endfor %}
    </div>
    
    <!-- Message Input -->
    {% if can_respond %}
    <form id="message-form" onsubmit="sendMessage(event)">
        <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <textarea id="message-input" 
                         placeholder="Nachricht eingeben..." 
                         style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; min-height: 60px; font-size: 14px; font-family: inherit;"
                         onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(event); }"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="height: 60px; padding: 0 20px;">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                </svg>
            </button>
        </div>
    </form>
    {% else %}
        {% if session.status == 'ended' %}
        <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; color: #495057;">
            Dieser Chat wurde beendet.
        </div>
        {% else %}
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; color: #856404;">
            Sie können in diesem Chat nicht antworten.
        </div>
        {% endif %}
    {% endif %}
</div>

<script>
let sessionId = '{{ session.session_id }}';
let lastMessageId = {% if messages.last %}{{ messages.last.id }}{% else %}0{% endif %};
let messagePolling = null;

function sendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    
    fetch(`/chat/api/agent/send/${sessionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            loadNewMessages();
        } else {
            alert('Fehler beim Senden der Nachricht: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Senden der Nachricht.');
    })
    .finally(() => {
        messageInput.disabled = false;
        messageInput.focus();
    });
}

function loadNewMessages() {
    fetch(`/chat/api/messages/${sessionId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messagesContainer = document.getElementById('chat-messages');
            const newMessages = data.messages.filter(msg => msg.id > lastMessageId);
            
            newMessages.forEach(msg => {
                addMessageToChat(msg);
                lastMessageId = Math.max(lastMessageId, msg.id);
            });
            
            // Update chat status if changed
            if (data.session_status === 'ended') {
                location.reload(); // Reload to show ended state
            }
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

function addMessageToChat(msg) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = document.createElement('div');
    messageEl.style.marginBottom = '15px';
    messageEl.className = 'chat-message';
    messageEl.setAttribute('data-message-id', msg.id);
    
    const isVisitor = msg.is_from_visitor;
    const isSystem = msg.message_type === 'system';
    
    if (isSystem) {
        messageEl.innerHTML = `
            <div style="text-align: center; color: #868e96; font-size: 12px; font-style: italic; padding: 8px;">
                ${msg.message}
            </div>
        `;
    } else if (isVisitor) {
        messageEl.innerHTML = `
            <div style="margin-left: 60px; text-align: right;">
                <div style="display: inline-block; max-width: 70%; padding: 10px 14px; background: #667eea; color: white; border-radius: 18px 18px 4px 18px; word-wrap: break-word;">
                    ${msg.message.replace(/\n/g, '<br>')}
                </div>
                <div style="font-size: 11px; color: #868e96; margin-top: 4px;">
                    ${msg.sender_name} • ${new Date(msg.timestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>
        `;
    } else {
        messageEl.innerHTML = `
            <div style="margin-right: 60px;">
                <div style="display: inline-block; max-width: 70%; padding: 10px 14px; background: white; color: #333; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;">
                    ${msg.message.replace(/\n/g, '<br>')}
                </div>
                <div style="font-size: 11px; color: #868e96; margin-top: 4px;">
                    ${msg.sender_name} • ${new Date(msg.timestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function endChat() {
    if (confirm('Möchten Sie diesen Chat wirklich beenden?')) {
        fetch(`/chat/api/end/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to show ended state
            } else {
                alert('Fehler beim Beenden des Chats: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Beenden des Chats.');
        });
    }
}

// Start polling for new messages if chat is active
{% if session.status == 'active' %}
messagePolling = setInterval(loadNewMessages, 3000);
{% endif %}

// Auto-scroll to bottom on page load
document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

// Focus message input
{% if can_respond %}
document.getElementById('message-input').focus();
{% endif %}
</script>
{% endblock %}