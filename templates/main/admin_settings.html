{% extends 'base.html' %}

{% block title %}System Einstellungen - {{ app_title }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1 style="font-size: 28px; font-weight: 600; margin: 0;">System Einstellungen</h1>
    <a href="{% url 'main:dashboard' %}" class="btn btn-secondary">
        ‚Üê Zur√ºck zum Dashboard
    </a>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Branding Section -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üé® Branding & Erscheinungsbild
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
                <label for="{{ form.app_name.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.app_name.label }}
                </label>
                {{ form.app_name }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.company_name.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.company_name.label }}
                </label>
                {{ form.company_name }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.site_url.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.site_url.label }}
                </label>
                {{ form.site_url }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.logo.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.logo.label }}
                </label>
                {{ form.logo }}
                {% if system_settings.logo %}
                <div style="margin-top: 10px;">
                    <small style="color: #868e96;">Aktuelles Logo:</small><br>
                    <img src="{{ system_settings.logo.url }}" alt="Current Logo" style="max-height: 50px; margin-top: 5px;">
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Email Configuration -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üìß E-Mail Konfiguration
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
                <label for="{{ form.smtp_host.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_host.label }}
                </label>
                {{ form.smtp_host }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_port.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_port.label }}
                </label>
                {{ form.smtp_port }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_username.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_username.label }}
                </label>
                {{ form.smtp_username }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_password.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_password.label }}
                </label>
                {{ form.smtp_password }}
                <small style="color: #868e96; font-size: 12px;">Leer lassen um aktuelles Passwort zu behalten</small>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                {{ form.smtp_use_tls }}
                <label for="{{ form.smtp_use_tls.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.smtp_use_tls.label }}
                </label>
            </div>
            
            <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                {{ form.send_email_notifications }}
                <label for="{{ form.send_email_notifications.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.send_email_notifications.label }}
                </label>
            </div>
        </div>
    </div>
    
    <!-- System Features -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            ‚öôÔ∏è System Features
        </h2>
        
        <div class="form-group">
            <label for="{{ form.max_upload_size_mb.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                {{ form.max_upload_size_mb.label }}
            </label>
            {{ form.max_upload_size_mb }}
        </div>
    </div>
    
    <!-- Live Chat Settings -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üí¨ Live Chat Einstellungen
        </h2>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.chat_enabled }}
                <label for="{{ form.chat_enabled.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.chat_enabled.label }}
                </label>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.widget_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.widget_color.label }}
                </label>
                {{ form.widget_color }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.widget_position.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.widget_position.label }}
                </label>
                {{ form.widget_position }}
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.welcome_message.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.welcome_message.label }}
                </label>
                {{ form.welcome_message }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.offline_message.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.offline_message.label }}
                </label>
                {{ form.offline_message }}
            </div>
        </div>
        
        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.auto_assign }}
                <label for="{{ form.auto_assign.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.auto_assign.label }}
                </label>
            </div>
            <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                Neue Chats automatisch an verf√ºgbare Agenten zuweisen
            </small>
        </div>
    </div>
    
    <!-- Chat Widget Integration -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üîó Chat Widget Integration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <p style="color: #495057; margin-bottom: 15px;">
                Verwenden Sie den folgenden Code, um das Live Chat Widget in externe Websites einzubinden:
            </p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">Widget URL:</strong>
                <div style="background: white; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 14px; color: #6f42c1;">
                    {{ widget_url }}
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">üìã HTML Iframe Code (empfohlen):</strong>
                <textarea readonly 
                          style="width: 100%; height: 120px; font-family: monospace; font-size: 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; resize: vertical;"
                          onclick="this.select();">{{ embed_code }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" onclick="copyToClipboard('iframe-code')" class="btn" style="background: #28a745; color: white; font-size: 12px; padding: 8px 16px;">
                        üìã Code kopieren
                    </button>
                    <small style="color: #868e96; margin-left: 10px;">F√ºgen Sie diesen Code vor dem schlie√üenden &lt;/body&gt; Tag ein</small>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">‚ö° JavaScript Code (dynamisch):</strong>
                <textarea readonly 
                          style="width: 100%; height: 140px; font-family: monospace; font-size: 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; resize: vertical;"
                          onclick="this.select();">{{ js_embed_code }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" onclick="copyToClipboard('js-code')" class="btn" style="background: #17a2b8; color: white; font-size: 12px; padding: 8px 16px;">
                        üìã Code kopieren
                    </button>
                    <small style="color: #868e96; margin-left: 10px;">L√§dt das Widget dynamisch nach dem Seitenaufbau</small>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 6px; border-left: 4px solid #2196f3;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">üí° Integration Tipps:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #495057;">
                    <li>Das Widget wird automatisch unten rechts auf der Seite angezeigt</li>
                    <li>Es ist responsive und funktioniert auf Desktop und Mobile</li>
                    <li>Position und Farbe k√∂nnen in den Chat Einstellungen angepasst werden</li>
                    <li>Das Widget zeigt automatisch Online/Offline Status</li>
                    <li>{% if chat_settings.is_enabled %}‚úÖ Chat ist derzeit <strong>aktiviert</strong>{% else %}‚ùå Chat ist derzeit <strong>deaktiviert</strong>{% endif %}</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- AI Settings -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            ü§ñ KI Chat Support
        </h2>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.ai_enabled }}
                <label for="{{ form.ai_enabled.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.ai_enabled.label }}
                </label>
            </div>
            <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                KI-gest√ºtzte Antworten f√ºr den Live Chat aktivieren
            </small>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.ai_provider.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_provider.label }}
                </label>
                {{ form.ai_provider }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Claude kann auch ohne API Key in der Free-Version genutzt werden
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.ai_response_delay.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_response_delay.label }}
                </label>
                {{ form.ai_response_delay }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Wartezeit bevor KI antwortet (wirkt nat√ºrlicher)
                </small>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.openai_api_key.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.openai_api_key.label }}
                </label>
                {{ form.openai_api_key }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Erforderlich f√ºr ChatGPT Integration. Leer lassen um aktuellen Key zu behalten.
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.anthropic_api_key.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.anthropic_api_key.label }}
                </label>
                {{ form.anthropic_api_key }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Optional f√ºr Claude Pro Features. Leer lassen um Free-Version zu nutzen.
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.ai_max_tokens.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_max_tokens.label }}
                </label>
                {{ form.ai_max_tokens }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Maximale L√§nge der KI-Antworten (100-2000 Tokens)
                </small>
            </div>
        </div>
    </div>
    
    <!-- Save Button -->
    <div style="text-align: center; margin-top: 40px;">
        <button type="submit" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px; font-weight: 600;">
            üíæ Einstellungen speichern
        </button>
    </div>
</form>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-check-input {
    width: 18px;
    height: 18px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

input[type="color"].form-control {
    height: 50px;
    padding: 5px;
    border-radius: 8px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #868e96;
    color: white;
}

.btn-secondary:hover {
    background: #6c757d;
    color: white;
    text-decoration: none;
}
</style>

<script>
function copyToClipboard(type) {
    let text = '';
    
    if (type === 'iframe-code') {
        text = `{{ embed_code|escapejs }}`;
    } else if (type === 'js-code') {
        text = `{{ js_embed_code|escapejs }}`;
    }
    
    // Erstelle ein tempor√§res textarea Element
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = text;
    document.body.appendChild(tempTextarea);
    
    // W√§hle und kopiere den Text
    tempTextarea.select();
    tempTextarea.setSelectionRange(0, 99999); // F√ºr mobile Ger√§te
    
    try {
        document.execCommand('copy');
        // Feedback f√ºr den Nutzer
        if (type === 'iframe-code') {
            event.target.innerHTML = '‚úÖ Kopiert!';
            event.target.style.background = '#28a745';
        } else {
            event.target.innerHTML = '‚úÖ Kopiert!';
            event.target.style.background = '#17a2b8';
        }
        
        // Zur√ºck zum urspr√ºnglichen Text nach 2 Sekunden
        setTimeout(() => {
            event.target.innerHTML = 'üìã Code kopieren';
            if (type === 'iframe-code') {
                event.target.style.background = '#28a745';
            } else {
                event.target.style.background = '#17a2b8';
            }
        }, 2000);
    } catch (err) {
        console.error('Kopieren fehlgeschlagen: ', err);
        alert('Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
    }
    
    // Entferne das tempor√§re Element
    document.body.removeChild(tempTextarea);
}

// Alternative moderne Clipboard API (falls verf√ºgbar)
if (navigator.clipboard && window.isSecureContext) {
    function copyToClipboard(type) {
        let text = '';
        
        if (type === 'iframe-code') {
            text = `{{ embed_code|escapejs }}`;
        } else if (type === 'js-code') {
            text = `{{ js_embed_code|escapejs }}`;
        }
        
        navigator.clipboard.writeText(text).then(() => {
            // Feedback f√ºr den Nutzer
            if (type === 'iframe-code') {
                event.target.innerHTML = '‚úÖ Kopiert!';
                event.target.style.background = '#28a745';
            } else {
                event.target.innerHTML = '‚úÖ Kopiert!';
                event.target.style.background = '#17a2b8';
            }
            
            // Zur√ºck zum urspr√ºnglichen Text nach 2 Sekunden
            setTimeout(() => {
                event.target.innerHTML = 'üìã Code kopieren';
                if (type === 'iframe-code') {
                    event.target.style.background = '#28a745';
                } else {
                    event.target.style.background = '#17a2b8';
                }
            }, 2000);
        }).catch(err => {
            console.error('Kopieren fehlgeschlagen: ', err);
            alert('Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
        });
    }
}
</script>
{% endblock %}