{% extends 'base.html' %}

{% block title %}System Einstellungen - {{ app_title }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1 style="font-size: 28px; font-weight: 600; margin: 0;">System Einstellungen</h1>
    <a href="{% url 'main:dashboard' %}" class="btn btn-secondary">
        ‚Üê Zur√ºck zum Dashboard
    </a>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Branding Section -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üé® Branding & Erscheinungsbild
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
                <label for="{{ form.app_name.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.app_name.label }}
                </label>
                {{ form.app_name }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.company_name.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.company_name.label }}
                </label>
                {{ form.company_name }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.site_url.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.site_url.label }}
                </label>
                {{ form.site_url }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.logo.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.logo.label }}
                </label>
                {{ form.logo }}
                {% if system_settings.logo %}
                <div style="margin-top: 10px;">
                    <small style="color: #868e96;">Aktuelles Logo:</small><br>
                    <img src="{{ system_settings.logo.url }}" alt="Current Logo" style="max-height: 50px; margin-top: 5px;">
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Email Configuration -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üìß E-Mail Konfiguration
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
                <label for="{{ form.smtp_host.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_host.label }}
                </label>
                {{ form.smtp_host }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_port.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_port.label }}
                </label>
                {{ form.smtp_port }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_username.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_username.label }}
                </label>
                {{ form.smtp_username }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.smtp_password.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.smtp_password.label }}
                </label>
                {{ form.smtp_password }}
                <small style="color: #868e96; font-size: 12px;">Leer lassen um aktuelles Passwort zu behalten</small>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                {{ form.smtp_use_tls }}
                <label for="{{ form.smtp_use_tls.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.smtp_use_tls.label }}
                </label>
            </div>
            
            <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                {{ form.send_email_notifications }}
                <label for="{{ form.send_email_notifications.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.send_email_notifications.label }}
                </label>
            </div>
        </div>
    </div>
    
    <!-- System Features -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            ‚öôÔ∏è System Features
        </h2>
        
        <div class="form-group">
            <label for="{{ form.max_upload_size_mb.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                {{ form.max_upload_size_mb.label }}
            </label>
            {{ form.max_upload_size_mb }}
        </div>
    </div>
    
    <!-- Live Chat Settings -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üí¨ Live Chat Einstellungen
        </h2>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.chat_enabled }}
                <label for="{{ form.chat_enabled.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.chat_enabled.label }}
                </label>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.widget_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.widget_color.label }}
                </label>
                {{ form.widget_color }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.widget_position.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.widget_position.label }}
                </label>
                {{ form.widget_position }}
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.welcome_message.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.welcome_message.label }}
                </label>
                {{ form.welcome_message }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.offline_message.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.offline_message.label }}
                </label>
                {{ form.offline_message }}
            </div>
        </div>
        
        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.auto_assign }}
                <label for="{{ form.auto_assign.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.auto_assign.label }}
                </label>
            </div>
            <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                Neue Chats automatisch an verf√ºgbare Agenten zuweisen
            </small>
        </div>
    </div>
    
    <!-- Chat Widget Integration -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üîó Chat Widget Integration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <p style="color: #495057; margin-bottom: 15px;">
                Verwenden Sie den folgenden Code, um das Live Chat Widget in externe Websites einzubinden:
            </p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">Widget URL:</strong>
                <div id="widget-url-display" style="background: white; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 14px; color: #6f42c1;">
                    {{ widget_url }}
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">üìã HTML Iframe Code (empfohlen):</strong>
                <textarea id="iframe-code" readonly
                          style="width: 100%; height: 120px; font-family: monospace; font-size: 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; resize: vertical;"
                          onclick="this.select();">{{ embed_code }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" onclick="copyToClipboard('iframe-code')" class="btn" style="background: #28a745; color: white; font-size: 12px; padding: 8px 16px;">
                        üìã Code kopieren
                    </button>
                    <small style="color: #868e96; margin-left: 10px;">F√ºgen Sie diesen Code vor dem schlie√üenden &lt;/body&gt; Tag ein</small>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                <strong style="color: #495057; display: block; margin-bottom: 10px;">‚ö° JavaScript Code (dynamisch):</strong>
                <textarea id="js-code" readonly
                          style="width: 100%; height: 140px; font-family: monospace; font-size: 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; resize: vertical;"
                          onclick="this.select();">{{ js_embed_code }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" onclick="copyToClipboard('js-code')" class="btn" style="background: #17a2b8; color: white; font-size: 12px; padding: 8px 16px;">
                        üìã Code kopieren
                    </button>
                    <small style="color: #868e96; margin-left: 10px;">L√§dt das Widget dynamisch nach dem Seitenaufbau</small>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 6px; border-left: 4px solid #2196f3;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">üí° Integration Tipps:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #495057;">
                    <li>Das Widget wird automatisch unten rechts auf der Seite angezeigt</li>
                    <li>Es ist responsive und funktioniert auf Desktop und Mobile</li>
                    <li>Position und Farbe k√∂nnen in den Chat Einstellungen angepasst werden</li>
                    <li>Das Widget zeigt automatisch Online/Offline Status</li>
                    <li>{% if chat_settings.is_enabled %}‚úÖ Chat ist derzeit <strong>aktiviert</strong>{% else %}‚ùå Chat ist derzeit <strong>deaktiviert</strong>{% endif %}</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Design Theme Settings -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            üé® Design Theme
        </h2>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
                <label for="{{ form.theme_variant.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.theme_variant.label }}
                </label>
                {{ form.theme_variant }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    W√§hlen Sie ein vordefiniertes Theme oder Custom f√ºr eigene Farben
                </small>
                <!-- Theme Preview Box -->
                <div style="margin-top: 15px; padding: 12px; background: var(--primary-color, #0066CC); border-radius: 6px; color: white; text-align: center; font-weight: 600;">
                    Theme Vorschau
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.font_family.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.font_family.label }}
                </label>
                {{ form.font_family }}
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px;">
            <div class="form-group">
                <label for="{{ form.primary_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.primary_color.label }}
                </label>
                {{ form.primary_color }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Buttons, Links
                </small>
            </div>

            <div class="form-group">
                <label for="{{ form.secondary_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.secondary_color.label }}
                </label>
                {{ form.secondary_color }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Success State
                </small>
            </div>

            <div class="form-group">
                <label for="{{ form.accent_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.accent_color.label }}
                </label>
                {{ form.accent_color }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    CTAs
                </small>
            </div>

            <div class="form-group">
                <label for="{{ form.danger_color.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.danger_color.label }}
                </label>
                {{ form.danger_color }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Fehler/Warnungen
                </small>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
            <div class="form-group">
                <label for="{{ form.border_radius.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.border_radius.label }}
                </label>
                {{ form.border_radius }}
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    {{ form.enable_dark_mode }}
                    <label for="{{ form.enable_dark_mode.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                        {{ form.enable_dark_mode.label }}
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Settings -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 25px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
            ü§ñ KI Chat Support
        </h2>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                {{ form.ai_enabled }}
                <label for="{{ form.ai_enabled.id_for_label }}" style="margin: 0; cursor: pointer; font-weight: 600; color: #495057;">
                    {{ form.ai_enabled.label }}
                </label>
            </div>
            <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                KI-gest√ºtzte Antworten f√ºr den Live Chat aktivieren
            </small>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.ai_provider.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_provider.label }}
                </label>
                {{ form.ai_provider }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Claude kann auch ohne API Key in der Free-Version genutzt werden
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.ai_response_delay.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_response_delay.label }}
                </label>
                {{ form.ai_response_delay }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Wartezeit bevor KI antwortet (wirkt nat√ºrlicher)
                </small>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="{{ form.openai_api_key.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.openai_api_key.label }}
                </label>
                {{ form.openai_api_key }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Erforderlich f√ºr ChatGPT Integration. Leer lassen um aktuellen Key zu behalten.
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.anthropic_api_key.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.anthropic_api_key.label }}
                </label>
                {{ form.anthropic_api_key }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Optional f√ºr Claude Pro Features. Leer lassen um Free-Version zu nutzen.
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.ai_max_tokens.id_for_label }}" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                    {{ form.ai_max_tokens.label }}
                </label>
                {{ form.ai_max_tokens }}
                <small style="color: #868e96; font-size: 12px; display: block; margin-top: 5px;">
                    Maximale L√§nge der KI-Antworten (100-2000 Tokens)
                </small>
            </div>
        </div>
    </div>
    
    <!-- Save Button -->
    <div style="text-align: center; margin-top: 40px;">
        <button type="submit" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px; font-weight: 600;">
            üíæ Einstellungen speichern
        </button>
    </div>
</form>

<!-- Settings update notification and auto-reload handler -->
<div id="settings-update-notification" style="display: none; position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 600;">
    ‚úÖ Einstellungen aktualisiert! Seite wird neu geladen...
</div>

<script>
// Auto-reload seite wenn Einstellungen gespeichert wurden
document.addEventListener('DOMContentLoaded', function() {
    // √úberpr√ºfe ob gerade eine Nachricht √ºber erfolgreiche Speicherung angezeigt wurde
    const messages = document.querySelectorAll('[class*="messages"]');
    let settingsSaved = false;

    for (let msg of messages) {
        if (msg.textContent && msg.textContent.includes('erfolgreich')) {
            settingsSaved = true;
            break;
        }
    }

    // Wenn Einstellungen gerade gespeichert wurden, zeige Benachrichtigung und lade neu
    if (settingsSaved) {
        const notification = document.getElementById('settings-update-notification');
        if (notification) {
            notification.style.display = 'block';

            // Reload nach 2 Sekunden damit Benutzer die Nachricht sieht
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }

    // Alternative: √úberwache den Form Submit und reload danach
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function() {
            // Show notification during submission
            const notification = document.getElementById('settings-update-notification');
            if (notification) {
                setTimeout(() => {
                    notification.style.display = 'block';
                }, 500);
            }
        });
    }
});

// Zus√§tzliche Funktion: Aktualisiere Logo in der Navbar sofort nach Upload (ohne Reload)
function updateLogoPreview() {
    const logoInput = document.querySelector('input[type="file"][accept*="image"]');
    if (logoInput) {
        logoInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Update preview image if exists
                    const previewImg = document.querySelector('img[alt="Current Logo"]');
                    if (previewImg) {
                        previewImg.src = event.target.result;
                    }
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    }
}

// Initialisiere Logo-Preview Update
document.addEventListener('DOMContentLoaded', updateLogoPreview);

// Theme Preview - Update CSS variables in real-time
function applyThemePreview() {
    const primaryInput = document.querySelector('input[id*="primary_color"]');
    const secondaryInput = document.querySelector('input[id*="secondary_color"]');
    const accentInput = document.querySelector('input[id*="accent_color"]');
    const dangerInput = document.querySelector('input[id*="danger_color"]');
    const borderRadiusInput = document.querySelector('input[id*="border_radius"]');
    const themeVariantSelect = document.querySelector('select[id*="theme_variant"]');

    function updateCSSVariables() {
        const root = document.documentElement;

        if (primaryInput && primaryInput.value) {
            root.style.setProperty('--primary-color', primaryInput.value);
        }
        if (secondaryInput && secondaryInput.value) {
            root.style.setProperty('--secondary-color', secondaryInput.value);
        }
        if (accentInput && accentInput.value) {
            root.style.setProperty('--accent-color', accentInput.value);
        }
        if (dangerInput && dangerInput.value) {
            root.style.setProperty('--danger-color', dangerInput.value);
        }
        if (borderRadiusInput && borderRadiusInput.value) {
            root.style.setProperty('--border-radius', borderRadiusInput.value + 'px');
        }
    }

    // Apply theme presets based on selection
    if (themeVariantSelect) {
        themeVariantSelect.addEventListener('change', function(e) {
            const variant = e.target.value;
            const root = document.documentElement;

            switch(variant) {
                case 'default':
                    root.style.setProperty('--primary-color', '#0066CC');
                    root.style.setProperty('--secondary-color', '#00B366');
                    root.style.setProperty('--accent-color', '#FF6600');
                    root.style.setProperty('--danger-color', '#CC0000');
                    break;
                case 'professional':
                    root.style.setProperty('--primary-color', '#1C3A70');
                    root.style.setProperty('--secondary-color', '#2E5090');
                    root.style.setProperty('--accent-color', '#0066CC');
                    root.style.setProperty('--danger-color', '#CC0000');
                    break;
                case 'bright':
                    root.style.setProperty('--primary-color', '#FF6600');
                    root.style.setProperty('--secondary-color', '#FFB300');
                    root.style.setProperty('--accent-color', '#FF3D00');
                    root.style.setProperty('--danger-color', '#CC0000');
                    break;
                case 'modern':
                    root.style.setProperty('--primary-color', '#6366F1');
                    root.style.setProperty('--secondary-color', '#10B981');
                    root.style.setProperty('--accent-color', '#F59E0B');
                    root.style.setProperty('--danger-color', '#EF4444');
                    break;
                case 'corporate':
                    root.style.setProperty('--primary-color', '#003D82');
                    root.style.setProperty('--secondary-color', '#0066CC');
                    root.style.setProperty('--accent-color', '#1A90FF');
                    root.style.setProperty('--danger-color', '#D32F2F');
                    break;
                case 'dark':
                    root.style.setProperty('--primary-color', '#1E1E1E');
                    root.style.setProperty('--secondary-color', '#333333');
                    root.style.setProperty('--accent-color', '#4A9EFF');
                    root.style.setProperty('--danger-color', '#FF6B6B');
                    break;
                // 'custom' - keep user's selected colors
            }
            updateCSSVariables();
        });
    }

    // Add event listeners to color inputs for live preview
    [primaryInput, secondaryInput, accentInput, dangerInput, borderRadiusInput].forEach(input => {
        if (input) {
            input.addEventListener('input', updateCSSVariables);
            input.addEventListener('change', updateCSSVariables);
        }
    });

    // Initial application
    updateCSSVariables();
}

// Initialize theme preview when DOM is ready
document.addEventListener('DOMContentLoaded', applyThemePreview);
</script>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-check-input {
    width: 18px;
    height: 18px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

input[type="color"].form-control {
    height: 50px;
    padding: 5px;
    border-radius: 8px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #868e96;
    color: white;
}

.btn-secondary:hover {
    background: #6c757d;
    color: white;
    text-decoration: none;
}
</style>

<script>
// Funktion zur Aktualisierung der Widget URL und Embed Codes
function updateWidgetUrl() {
    const siteUrlInput = document.getElementById('id_site_url');
    if (!siteUrlInput) return;

    let siteUrl = siteUrlInput.value.trim();

    // Stelle sicher, dass die URL mit http:// oder https:// beginnt
    if (siteUrl && !siteUrl.match(/^https?:\/\//)) {
        siteUrl = 'https://' + siteUrl;
    }

    // Entferne trailing slash
    siteUrl = siteUrl.replace(/\/$/, '');

    if (!siteUrl) {
        siteUrl = 'http://localhost:8000';
    }

    const widgetUrl = siteUrl + '/chat/widget/';

    // Aktualisiere die Widget URL Anzeige
    const widgetUrlDisplay = document.getElementById('widget-url-display');
    if (widgetUrlDisplay) {
        widgetUrlDisplay.textContent = widgetUrl;
    }

    // Aktualisiere Iframe Code
    const iframeCodeTextarea = document.getElementById('iframe-code');
    if (iframeCodeTextarea) {
        const newIframeCode = `<!-- Aboro-IT Helpdesk Live Chat Widget -->
<iframe src="${widgetUrl}"
        width="400"
        height="600"
        frameborder="0"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
</iframe>`;
        iframeCodeTextarea.value = newIframeCode;
    }

    // Aktualisiere JavaScript Code
    const jsCodeTextarea = document.getElementById('js-code');
    if (jsCodeTextarea) {
        const newJsCode = `<!-- Aboro-IT Helpdesk Live Chat Widget (JavaScript) -->
<script>
(function() {
    var iframe = document.createElement('iframe');
    iframe.src = '${widgetUrl}';
    iframe.width = '400';
    iframe.height = '600';
    iframe.frameBorder = '0';
    iframe.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);';

    // Auto-open chat when loaded in iframe
    iframe.onload = function() {
        try {
            iframe.contentWindow.postMessage({'action': 'openChat'}, '${siteUrl}');
        } catch(e) {
            console.log('Chat widget loaded');
        }
    };

    document.body.appendChild(iframe);
})();
<\/script>`;
        jsCodeTextarea.value = newJsCode;
    }
}

// Event Listener f√ºr Site URL Input
document.addEventListener('DOMContentLoaded', function() {
    const siteUrlInput = document.getElementById('id_site_url');
    if (siteUrlInput) {
        siteUrlInput.addEventListener('input', updateWidgetUrl);
        siteUrlInput.addEventListener('change', updateWidgetUrl);
    }
});

function copyToClipboard(type) {
    let text = '';

    if (type === 'iframe-code') {
        const textarea = document.getElementById('iframe-code');
        text = textarea ? textarea.value : `{{ embed_code|escapejs }}`;
    } else if (type === 'js-code') {
        const textarea = document.getElementById('js-code');
        text = textarea ? textarea.value : `{{ js_embed_code|escapejs }}`;
    }

    // Erstelle ein tempor√§res textarea Element
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = text;
    document.body.appendChild(tempTextarea);

    // W√§hle und kopiere den Text
    tempTextarea.select();
    tempTextarea.setSelectionRange(0, 99999); // F√ºr mobile Ger√§te

    try {
        document.execCommand('copy');
        // Feedback f√ºr den Nutzer
        if (type === 'iframe-code') {
            event.target.innerHTML = '‚úÖ Kopiert!';
            event.target.style.background = '#28a745';
        } else {
            event.target.innerHTML = '‚úÖ Kopiert!';
            event.target.style.background = '#17a2b8';
        }

        // Zur√ºck zum urspr√ºnglichen Text nach 2 Sekunden
        setTimeout(() => {
            event.target.innerHTML = 'üìã Code kopieren';
            if (type === 'iframe-code') {
                event.target.style.background = '#28a745';
            } else {
                event.target.style.background = '#17a2b8';
            }
        }, 2000);
    } catch (err) {
        console.error('Kopieren fehlgeschlagen: ', err);
        alert('Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
    }

    // Entferne das tempor√§re Element
    document.body.removeChild(tempTextarea);
}

// Alternative moderne Clipboard API (falls verf√ºgbar)
if (navigator.clipboard && window.isSecureContext) {
    function copyToClipboard(type) {
        let text = '';

        if (type === 'iframe-code') {
            const textarea = document.getElementById('iframe-code');
            text = textarea ? textarea.value : `{{ embed_code|escapejs }}`;
        } else if (type === 'js-code') {
            const textarea = document.getElementById('js-code');
            text = textarea ? textarea.value : `{{ js_embed_code|escapejs }}`;
        }

        navigator.clipboard.writeText(text).then(() => {
            // Feedback f√ºr den Nutzer
            if (type === 'iframe-code') {
                event.target.innerHTML = '‚úÖ Kopiert!';
                event.target.style.background = '#28a745';
            } else {
                event.target.innerHTML = '‚úÖ Kopiert!';
                event.target.style.background = '#17a2b8';
            }

            // Zur√ºck zum urspr√ºnglichen Text nach 2 Sekunden
            setTimeout(() => {
                event.target.innerHTML = 'üìã Code kopieren';
                if (type === 'iframe-code') {
                    event.target.style.background = '#28a745';
                } else {
                    event.target.style.background = '#17a2b8';
                }
            }, 2000);
        }).catch(err => {
            console.error('Kopieren fehlgeschlagen: ', err);
            alert('Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
        });
    }
}
</script>
{% endblock %}